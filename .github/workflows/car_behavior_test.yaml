name: Car Behavior Test

on:
  pull_request:
    paths:
      - 'opendbc/car/**'
      - 'opendbc/dbc/**'

jobs:
  car-behavior-test:
    name: car behavior replay
    runs-on: ${{ github.repository == 'commaai/opendbc' && 'namespace-profile-amd64-8x16' || 'ubuntu-latest' }}
    env:
      BASE_IMAGE: openpilot-base
      BUILD: selfdrive/test/docker_build.sh base
      RUN: docker run --shm-size 2G -v $PWD:/tmp/openpilot -w /tmp/openpilot -e CI=1 -e PYTHONPATH=/tmp/openpilot -e HF_TOKEN -v $GITHUB_WORKSPACE/.ci_cache/comma_download_cache:/tmp/comma_download_cache $BASE_IMAGE /bin/bash -c
    steps:
    - uses: actions/checkout@v4
      with:
        repository: 'commaai/openpilot'
        ref: 'master'
        submodules: true

    - name: Remove default opendbc
      run: rm -rf opendbc_repo/

    - name: Checkout PR
      uses: actions/checkout@v4
      with:
        path: opendbc_repo
        fetch-depth: 0

    - name: Fetch master for baseline
      run: cd opendbc_repo && git fetch origin master

    - uses: ./.github/workflows/setup-with-retry

    - name: Build openpilot
      run: ${{ env.RUN }} "scons -j$(nproc) opendbc_repo/"

    - name: Run car behavior replay test
      run: |
        ${{ env.RUN }} "python opendbc/car/test/test_replay_compare.py --pr ${{ github.event.pull_request.number }} --use-hf --segments-per-platform 10"
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
